CC=gcc
CFLAGS=-O0 -g -Werror

CXX=g++
CXXFLAGS=$(CFLAGS) -std=c++11

CPPFLAGS=-Ilibkz/include

LD=gcc
LDFLAGS=
LIBS=-lm

GHC=ghc
GHCFLAGS=-W -Werror

RUNGHC=runghc
RUNGHCFLAGS=-W -fno-warn-unused-imports

HAPPY=happy 
HAPPY_ARGS=-agci

ALEX=alex 
ALEX_ARGS=-gi

#
# No built-in rules
#
MAKEFLAGS += --no-builtin-rules

#
# opt and noopt make commands
#
OPT_MAKECMD := $(filter opt, $(MAKECMDGOALS))
MAKECMDGOALS := $(filter-out opt, $(MAKECMDGOALS))

NOOPT_MAKECMD := $(filter noopt, $(MAKECMDGOALS))
MAKECMDGOALS := $(filter-out noopt, $(MAKECMDGOALS))

ifeq ($(OPT_MAKECMD), opt)
VIRTUAL_GOALS += opt

OPT_MAKECMD := 1
OPT := 1
else
OPT_MAKECMD := 0
OPT := 0
endif

ifeq ($(NOOPT_MAKECMD), noopt)
VIRTUAL_GOALS += noopt

NOOPT_MAKECMD := 1
NOOPT := 1
else
NOOPT_MAKECMD := 0
endif

#
# Support cabal sandbox
#
ifneq ($(wildcard .cabal-sandbox/*-packages.conf.d),)
GHCFLAGS += \
	-no-user-package-db \
	-package-db $(wildcard .cabal-sandbox/*-packages.conf.d)

RUNGHCFLAGS += \
	-no-user-package-db \
	-package-db --ghc-arg=$(wildcard .cabal-sandbox/*-packages.conf.d)
endif

#
# Support Cabal's MIN_VERSION
#
GHCFLAGS += -optP-include -optPdist/build/autogen/cabal_macros.h

#
# GHC flags
#
GHCFLAGS += \
	-hide-all-packages \
	-package array \
	-package base \
	-package binary \
	-package bytestring \
	-package containers \
	-package directory \
	-package exception-mtl \
	-package exception-transformers \
	-package filepath \
        -package free \
	-package language-c-quote \
	-package mainland-pretty \
	-package mtl \
	-package process \
	-package ref-fd \
	-package srcloc \
	-package syb \
	-package symbol \
	-package text \
	-package template-haskell \
	-package transformers

GHCFLAGS_OPT = -O2 -funbox-strict-fields

ifeq ($(OPT), 1)
GHCFLAGS += $(GHCFLAGS_OPT)
endif

#
# Source locations
#
SRCDIR = src/

GHCFLAGS+=-i$(SRCDIR) -I$(SRCDIR)
RUNGHCFLAGS+=-i$(SRCDIR) -I$(SRCDIR)

GHCFLAGS+=-Iinclude

SOURCE = \
	KZC/Cg.hs \
	KZC/Cg/Monad.hs \
	KZC/Check.hs \
	KZC/Check/Monad.hs \
	KZC/Check/State.hs \
	KZC/Check/Types.hs \
	KZC/Core/Smart.hs \
	KZC/Core/Syntax.hs \
	KZC/Derive.hs \
	KZC/Error.hs \
	KZC/Flags.hs \
	KZC/Globals.hs \
	KZC/Monad.hs \
	KZC/LambdaLift.hs \
	KZC/LambdaLift/Monad.hs \
	KZC/Lint.hs \
	KZC/Lint/Monad.hs \
	KZC/Lint/State.hs \
	KZC/Name.hs \
	KZC/Platform.hs \
	KZC/Pretty.hs \
	KZC/Rename.hs \
	KZC/Rename/Monad.hs \
	KZC/Summary.hs \
	KZC/Staged.hs \
	KZC/SysTools.hs \
	KZC/Uniq.hs \
	KZC/Util/SetLike.hs \
	KZC/Vars.hs \
	Language/Ziria/Parser/Alex.hs \
	Language/Ziria/Parser/Exceptions.hs \
	Language/Ziria/Parser/Lexer.hs \
	Language/Ziria/Parser/Monad.hs \
	Language/Ziria/Parser/Tokens.hs \
	Language/Ziria/Parser.hs \
	Language/Ziria/Smart.hs \
	Language/Ziria/Syntax.hs \
	Main.hs \
	Opts.hs

GENERATED = \
	KZC/Check/Types-instances.hs \
	KZC/Core/Syntax-instances.hs \
	Language/Ziria/Parser/Lexer.hs \
	Language/Ziria/Parser/Parser.hs \
	Language/Ziria/Syntax-instances.hs

SRC = $(patsubst %,$(SRCDIR)%,$(SOURCE)) $(patsubst %,$(SRCDIR)%,$(GENERATED))

#
# all, clean, and distclean targets
#
.PHONY : all
all : kzc

.PHONY : clean
clean :
	rm -rf kzc obj $(patsubst %,$(SRCDIR)%,$(GENERATED)) libkz/src/*.o

.PHONY : distclean
distclean : clean
	rm -rf \
	    dist \
	    autom4te.cache configure config.log config.status \
	    include/KzcConfig.h include/KzcSysTools.h Makefile kzc.buildinfo

#
# kzc compiler
#
kzc : $(SRC) dist/build/autogen/cabal_macros.h
	@mkdir -p obj
	$(GHC) $(GHCFLAGS) --make $(SRCDIR)Main.hs -odir obj -hidir obj \
		-o $@

#
# Generated instances
#
$(SRCDIR)KZC/Check/Types-instances.hs : bin/gen-tc-instances.hs $(SRCDIR)KZC/Derive.hs $(SRCDIR)KZC/Check/Types.hs
	runhaskell $(RUNGHCFLAGS) -DONLY_TYPEDEFS $< > $@ || rm -f $@

$(SRCDIR)KZC/Core/Syntax-instances.hs : bin/gen-core-instances.hs $(SRCDIR)KZC/Derive.hs $(SRCDIR)KZC/Core/Syntax.hs
	runhaskell $(RUNGHCFLAGS) -DONLY_TYPEDEFS $< > $@ || rm -f $@

$(SRCDIR)Language/Ziria/Syntax-instances.hs : bin/gen-ziria-instances.hs $(SRCDIR)KZC/Derive.hs $(SRCDIR)Language/Ziria/Syntax.hs
	runhaskell $(RUNGHCFLAGS) -DONLY_TYPEDEFS $< > $@ || rm -f $@

#
# Lexer and parser generation
#
$(SRCDIR)Language/Ziria/Parser/Parser.hs : $(SRCDIR)Language/Ziria/Parser/Parser.y
	$(HAPPY) $(HAPPY_ARGS) -o $@ $<

$(SRCDIR)Language/Ziria/Parser/Lexer.hs : $(SRCDIR)Language/Ziria/Parser/Lexer.x
	$(ALEX) $(ALEX_ARGS) -o $@ $<

#
# Executables
#

KZC=./kzc
KZCFLAGS=-I$(TESTDIR)/lib --dlint --ddump-core --ddump-lift --dtrace-lint --dtrace-cg --fno-line-pragmas

RUNTIME_SRC = libkz/src/driver.c libkz/src/ext.c libkz/src/io.cpp libkz/src/rt.c
RUNTIME_OBJ = $(patsubst %.cpp,%.o,$(patsubst %.c,%.o,$(RUNTIME_SRC)))

.PRECIOUS : $(RUNTIME_OBJ)

%.c : %.blk kzc
	$(KZC) $(KZCFLAGS) $< -o $@

%.c : %.wpl kzc
	$(KZC) $(KZCFLAGS) $< -o $@

%.c : %.zr kzc
	$(KZC) $(KZCFLAGS) $< -o $@

%.o : %.c
	$(CC) $(CPPFLAGS) $(CFLAGS) -c $< -o $@

%.o : %.cpp
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $< -o $@

%.exe : %.o $(RUNTIME_OBJ)
	$(LD) $(LDFLAGS) $< $(RUNTIME_OBJ) $(LIBS) -o $@

%.outfile : %.exe %.infile
	$< --input=$*.infile --output=$*.outfile

#
# Tests
#
TESTDIR = testsuite

TESTS = \
	$(shell ls $(TESTDIR)/tests/parser/*.wpl | sort) \
	$(shell ls $(TESTDIR)/tests/backend/*.wpl | sort) \
	$(shell ls $(TESTDIR)/tests/libs/*.blk | sort) \
	$(shell ls $(TESTDIR)/tests/libs/*.wpl | sort) \
	$(shell ls $(TESTDIR)/tests/vectorizer/transmitter.blk | sort) \
	$(shell ls $(TESTDIR)/code/WiFi/tests/*.blk | sort) \
	$(shell ls $(TESTDIR)/code/WiFi/transmitter/tests/*.blk | sort) \
	$(shell ls $(TESTDIR)/code/WiFi/receiver/tests/*.blk | sort)

.PHONY : test-parser
test-parser : kzc
	set -e; \
	for TEST in $(TESTS); do \
		echo $$TEST; \
		./kzc $(KZCFLAGS) -P $$TEST; \
	done

.PHONY : test-tc
test-tc : kzc
	set -e; \
	for TEST in $(TESTS); do \
		echo $$TEST; \
		./kzc $(KZCFLAGS) -C $$TEST; \
	done

.PHONY : test-compiler
test-compiler : kzc
	set -e; \
	for TEST in $(TESTS); do \
		echo $$TEST; \
		./kzc $(KZCFLAGS) $$TEST -o test.c; \
		$(MAKE) test.exe; \
	done

GROUNDFILES= \
	$(shell ls $(TESTDIR)/tests/parser/*.outfile.ground | sort) \
	$(shell ls $(TESTDIR)/tests/backend/*.outfile.ground | sort) \
	$(shell ls $(TESTDIR)/tests/libs/*.outfile.ground | sort) \
	$(shell ls $(TESTDIR)/tests/vectorizer/transmitter.outfile.ground | sort) \
	$(shell ls $(TESTDIR)/code/WiFi/tests/*.outfile.ground | sort) \
	$(shell ls $(TESTDIR)/code/WiFi/transmitter/tests/*.outfile.ground | sort) \
	$(shell ls $(TESTDIR)/code/WiFi/receiver/tests/*.outfile.ground | sort)

GROUNDTESTS=$(patsubst %.outfile.ground,%,$(GROUNDFILES))

.PHONY : test-ground
test-ground : kzc
	set -e; \
	for TEST in $(GROUNDTESTS); do \
		echo $$TEST; \
		$(MAKE) $$TEST.outfile; \
	done

#
# autotools stuff
#
include/KzcConfig.h.in : configure.ac aclocal.m4
	autoheader

Makefile : Makefile.in
	./config.status

%.h : %.h.in
	./config.status

%.buildinfo : %.buildinfo.in
	./config.status

dist/build/autogen/cabal_macros.h :
	cabal build

#
# Print Makefile variables
#
print-%: ; @echo $*=$($*)

#
# Rules for virtual goals
#
ifeq ($(MAKECMDGOALS),)
$(VIRTUAL_GOALS) : all
	@true
else
$(VIRTUAL_GOALS) :
	@true
endif
